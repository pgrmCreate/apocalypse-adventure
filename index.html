<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>Before Dawn - v0.9.8</title>
        <link id="main-stylesheet" rel="stylesheet" href="style.css">
    </head>
    <body>
        <div id="new-game-screen" class="new-game-screen hidden">
            <div class="new-game-panel">
                <p class="new-game-kicker">Nouvelle partie</p>
                <h2 class="new-game-title">Prépare ton survivant</h2>
                <p class="new-game-text">
                    Avant de partir dans l'inconnu, choisis le nom de ton héros.
                </p>
                <form id="new-game-form" class="new-game-form">
                    <label for="new-game-name" class="sr-only">Nom du survivant</label>
                    <div class="new-game-input-row">
                        <input
                            id="new-game-name"
                            name="hero-name"
                            type="text"
                            autocomplete="name"
                            required
                            minlength="2"
                            maxlength="30"
                            placeholder="Ton nom"
                        />
                        <button type="submit" class="choice-btn new-game-submit">Commencer</button>
                    </div>
                </form>
            </div>
        </div>
        <div class="app">
            <header>
                <h1 class="app-title">Before Dawn</h1>
            </header>

            <div id="toast-container" class="toast-container"></div>
            <div id="combat-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="combat-modal-title">
                <div class="modal-content">
                    <h2 id="combat-modal-title">Un combat commence</h2>
                    <p id="combat-modal-location" class="modal-meta"></p>
                    <p id="combat-modal-difficulty" class="modal-meta"></p>
                    <p id="combat-modal-description"></p>
                    <button id="combat-modal-confirm" class="choice-btn modal-confirm">OK</button>
                </div>
            </div>

            <div id="outcome-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="outcome-modal-title">
                <div class="modal-content">
                    <h2 id="outcome-modal-title">Action résolue</h2>
                    <p id="outcome-modal-description" class="modal-meta"></p>
                    <p id="outcome-modal-effect"></p>
                    <button id="outcome-modal-confirm" class="choice-btn modal-confirm">Continuer</button>
                </div>
            </div>

            <div id="quest-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="quest-modal-title">
                <div class="modal-content">
                    <h2 id="quest-modal-title">Quête actuelle</h2>
                    <p class="modal-text">
                        Tu te réveilles, une autre journée commence et les secours ne viendront pas. Les réserves se vident... 
                        pas le choix... il faut partir !
                    </p>
                    <p id="quest-modal-description" class="modal-meta"></p>
                    <button id="quest-modal-close" class="choice-btn modal-confirm">Compris</button>
                </div>
            </div>

            <div
                id="defeat-modal"
                class="modal hidden"
                role="dialog"
                aria-modal="true"
                aria-labelledby="defeat-modal-title"
            >
                <div class="modal-content">
                    <h2 id="defeat-modal-title">Tu es mort</h2>
                    <p id="defeat-modal-message" class="modal-meta"></p>
                    <button id="defeat-modal-restart" class="choice-btn modal-confirm">Recommencer</button>
                </div>
            </div>
                        <div
                id="inventory-modal"
                class="modal hidden"
                role="dialog"
                aria-modal="true"
                aria-labelledby="inventory-modal-title"
            >
                <div class="modal-content wide-modal inventory-modal">
                    <div class="modal-header">
                        <div class="modal-heading">
                            <p class="modal-kicker">Sac & craft</p>
                            <h2 id="inventory-modal-title">Inventaire</h2>
                        </div>
                        <div class="modal-actions">
                            <div class="modal-meta" id="inventory-modal-capacity"></div>
                            <button id="inventory-modal-close" class="secondary-btn modal-close" type="button">
                                Fermer
                            </button>
                        </div>
                    </div>
                    <div class="modal-scroll">
                        <section class="inventory-panel personal-panel" id="inventory-panel">
                            <h2>Inventaire du héros</h2>
                            <div class="capacity">
                                Charge : <span id="capacity-value"></span>
                                <div class="bag-info">Sac actuel : <span id="bag-name"></span></div>
                            </div>

                            <section class="item-actions-panel inline">
                                <h3>Objet sélectionné</h3>
                                <div id="selected-item-name" class="selected-name">Aucun</div>
                                <div id="selected-item-info" class="selected-info"></div>
                                <div id="selected-item-buttons" class="selected-buttons"></div>
                            </section>

                            <div class="personal-row">
                                <div class="inventory-column">
                                    <h3>Sur toi</h3>
                                    <div id="inventory-zone" class="drop-zone" data-zone="inventory">
                                        <!-- objets dans l'inventaire -->
                                    </div>
                                </div>
                            </div>

                            <section class="craft-panel">
                                <h3>Crafting</h3>
                                <div id="craft-info" class="craft-info">
                                    Disponible uniquement en temps long (hors action urgente).
                                </div>
                                <div id="craft-list" class="craft-list"></div>
                            </section>

                            <p class="hint">
                                Astuce : clique sur un objet pour voir ses stats, l'équiper, le consommer
                                ou le <strong>prendre</strong>.<br>
                                Certains objets peuvent aussi être <strong>craftés</strong> à partir d'autres
                                (par exemple : <em>planche + couteau = lance</em>).
                            </p>
                        </section>
                    </div>
                </div>
            </div>
            <div
                id="status-modal"
                class="modal hidden"
                role="dialog"
                aria-modal="true"
                aria-labelledby="status-modal-title"
            >
                <div class="modal-content wide-modal status-modal">
                    <div class="modal-header">
                        <div class="modal-heading">
                            <p class="modal-kicker">État du survivant</p>
                            <h2 id="status-modal-title">Statistiques & blessures</h2>
                        </div>
                        <div class="modal-actions">
                            <button id="status-modal-close" class="secondary-btn modal-close" type="button">
                                Fermer
                            </button>
                        </div>
                    </div>
                    <div class="modal-scroll">
                        <section class="hero-panel" id="hero-panel">
                            <h2>Héros</h2>
                            <div class="hero-name">Nom : <span id="hero-name"></span></div>
                            <ul class="stats">
                                <li>PV : <span id="stat-hp"></span></li>
                                <li>Force : <span id="stat-force"></span></li>
                                <li>Finesse : <span id="stat-finesse"></span></li>
                                <li>Audace : <span id="stat-audace"></span></li>
                                <li>XP : <span id="stat-xp"></span></li>
                                <li>Palier : <span id="stat-xp-threshold"></span></li>
                                <li>Faim : <span id="stat-hunger"></span></li>
                                <li>Soif : <span id="stat-thirst"></span></li>
                            </ul>
                        </section>
                        <section class="wound-panel" id="wound-panel">
                            <h3 id="wound-header">Blessures</h3>
                            <div id="wounds" class="wounds"></div>
                        </section>
                        
                    </div>
                </div>
            </div>
            <div class="floating-tags" aria-label="Raccourcis fixes">
                <button class="tag-btn" id="tag-inventory" type="button" title="Ouvrir l'inventaire">
                    <svg
                        class="tag-icon"
                        aria-hidden="true"
                        xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 24 24"
                    >
                        <path
                            fill="currentColor"
                            d="M9 5.5A3.5 3.5 0 0 1 12.5 2h-.9A3.6 3.6 0 0 0 8 5.6v.9a2 2 0 0 0-2 2V19a3 3 0 0 0 3 3h6a3 3 0 0 0 3-3V8.5a2 2 0 0 0-2-2v-.9A3.6 3.6 0 0 0 12.4 2h-.9A3.5 3.5 0 0 1 15 5.5V6H9v-.5ZM8 10h8v1.5H8V10Zm0 4h8v1.5H8V14Z"
                        />
                    </svg>
                    <span class="tag-label" id="tag-inventory-capacity"></span>
                    <span class="sr-only">Inventaire</span>
                </button>
                <button class="tag-btn" id="tag-stats" type="button" title="Voir les stats">
                    <svg
                        class="tag-icon"
                        aria-hidden="true"
                        xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 24 24"
                    >
                        <path
                            fill="currentColor"
                            d="M6.5 11H4a1 1 0 0 0-1 1v7h3.5v-8ZM14.75 5H9.25A1.25 1.25 0 0 0 8 6.25V19h7.5V6.25A1.25 1.25 0 0 0 14.75 5ZM20 9h-2.5v10H21v-9a1 1 0 0 0-1-1Z"
                        />
                    </svg>
                    <span class="sr-only">Statistiques</span>
                </button>
                <button
                    class="tag-btn tag-danger hidden"
                    id="tag-wounds"
                    type="button"
                    title="Voir les blessures"
                >
                    <svg
                        class="tag-icon"
                        aria-hidden="true"
                        xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 24 24"
                    >
                        <path
                            fill="currentColor"
                            d="M12 3c-3.5 5.2-5.5 8.4-5.5 11.3A5.5 5.5 0 0 0 12 20a5.5 5.5 0 0 0 5.5-5.7C17.5 11.4 15.5 8.2 12 3Z"
                        />
                    </svg>
                    <span class="tag-counter" id="tag-wound-count" aria-hidden="true"></span>
                    <span class="sr-only">Blessures</span>
                </button>
            </div>

            <div class="floating-alarm" aria-label="Heure en jeu">
                <button class="tag-btn tag-quest tag-quest-left" id="tag-quest" type="button" title="Voir la quête actuelle">
                    <svg
                        class="tag-icon"
                        aria-hidden="true"
                        xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 24 24"
                    >
                        <path
                            fill="#fff"
                            d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2Zm1 17.93V18a1 1 0 0 0-2 0v1.93A8.06 8.06 0 0 1 4.07 13H6a1 1 0 0 0 0-2H4.07A8.06 8.06 0 0 1 11 4.07V6a1 1 0 0 0 2 0V4.07A8.06 8.06 0 0 1 19.93 11H18a1 1 0 0 0 0 2h1.93A8.06 8.06 0 0 1 13 19.93ZM12 9a3 3 0 1 0 3 3a3 3 0 0 0-3-3Zm0 4a1 1 0 1 1 1-1a1 1 0 0 1-1 1Z"
                        />
                    </svg>
                    <span class="sr-only">Quête</span>
                </button>
                <div id="game-clock" class="time-tag" aria-label="Heure en jeu">08:00</div>
            </div>

            <main class="layout">
                <section id="game">
                    <h2 id="story-title"></h2>
                    <p id="time-context" class="time-context-label"></p>
                    <div id="story-text" class="story-text"></div>

                    <div class="choice-title" id="choice-title">Que fais-tu ?</div>
                    <div id="choices" class="choices"></div>

                    <section id="map-section" class="map-section hidden">
                        <div class="map-header">Carte du lieu</div>
                        <canvas id="map-canvas" aria-label="Carte des déplacements"></canvas>
                    </section>
                </section>

                <aside id="sidebar">
                    <section class="inventory-panel ground-panel" id="ground-panel">
                        <h2>Au sol</h2>
                        <div class="ground-row">
                            <div class="inventory-column">
                                <h3>Objets trouvés / au sol</h3>
                                <button id="take-all-btn" class="secondary-btn inline-btn">
                                    Tout prendre
                                </button>
                                <div id="lost-throwable-actions" class="lost-throwable-actions"></div>
                                <div id="loot-zone" class="drop-zone" data-zone="loot">
                                    <!-- loot du lieu -->
                                </div>
                            </div>
                        </div>
                    </section>

                    <section class="weapon-panel">
                        <h2>Combat</h2>
                        <div class="equipped-name">
                        <div class="equipped-name">
                            Arme ?quip?e : <span id="equipped-weapon-name">Aucune (poings seulement)</span>
                        <div class="attack-summary">
                        <div class="attack-summary">
                            D?g?ts min. estim?s (avant d?s) : <span id="attack-preview"></span>
                    </section>
                </aside>
            </main>
            <section class="log-section bottom-log">
            <section class="log-section bottom-log">
                <h3>Journal & jets de d?s</h3>
            </section>

            <footer>
                <button id="restart-btn" class="secondary-btn">Recommencer la partie</button>
            </footer>
        </div>

        <script type="module">
            import { GAME_CONSTANTS } from "./game-constants.js";

            const cacheBust = `?v=${GAME_CONSTANTS.CACHE_BUSTER}`;
            const stylesheet = document.getElementById("main-stylesheet");
            if (stylesheet) {
                stylesheet.href += cacheBust;
            }

            const loadScript = (src, isModule = false) =>
                new Promise((resolve, reject) => {
                    const script = document.createElement("script");
                    script.src = `${src}${cacheBust}`;
                    script.type = isModule ? "module" : "text/javascript";
                    script.onload = resolve;
                    script.onerror = reject;
                    document.body.appendChild(script);
                });

            await loadScript("./items.js");
            await loadScript("./game-story.js");
            await loadScript("./script.js", true);
        </script>

        <div id="damage-flash" class="damage-flash" aria-hidden="true"></div>

        <div id="asset-loader" class="asset-loader hidden" role="status" aria-live="polite">
            <div class="asset-loader-backdrop"></div>
            <div class="asset-loader-box">
                <div class="loader" aria-hidden="true"></div>
                <div class="asset-loader-title">Chargement du jeu</div>
                <div id="asset-loader-progress" class="asset-loader-progress">
                    Préparation des ressources
                </div>
            </div>
        </div>

        <div id="action-overlay" class="action-overlay hidden" aria-live="polite">
            <div class="action-overlay-backdrop"></div>
            <div class="action-overlay-box">
                <div class="action-overlay-spinner" aria-hidden="true"></div>
                <div class="action-overlay-progress" aria-hidden="true">
                    <div class="action-overlay-bar" id="action-progress-bar"></div>
                </div>
                <button id="action-overlay-cancel" class="action-overlay-cancel hidden" type="button">
                    Interrompre
                </button>
                <div class="action-overlay-label" id="action-overlay-text"></div>
            </div>
        </div>
    </body>
</html>
